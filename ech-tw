import { connect } from "cloudflare:sockets";

const UUID = "e258977b-e413-4718-a3af-02d75492c349";

const FALLBACK_HOST = "tw.x9527.xyz";
const FALLBACK_PORT = 443;

const WS_PATH = encodeURIComponent("/?ed=2095");

const ENABLE_ECH = true;

const CSV_URL = "https://github.xmm1993.top/qq525448560/wbccq/refs/heads/main/hebing.csv?token=aniu";

const AT_IPV4 = 1;
const AT_DOMAIN = 2;
const AT_IPV6 = 3;

const te = new TextEncoder();
const td = new TextDecoder();

export default {
  async fetch(request, env) {
    try {
      const url = new URL(request.url);

      if (request.headers.get("Upgrade") === "websocket") {
        return handleWsRequest(request);
      }

      if (request.method === "GET") {
        if (url.pathname === "/") {
          return new Response(
            "`<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Powered by Cloudflare</title><script src="https://cdn.tailwindcss.com"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"><script src="https://cdn.jsdelivr.net/npm/chart.js"></script><script>tailwind.config={theme:{extend:{colors:{cloudflare:{blue:'#F38020',dark:'#16181C',light:'#F7FAFC',gray:'#6E7681'}},fontFamily:{sans:['Inter','system-ui','sans-serif']}}}}</script><style>@layer utilities{.content-auto{content-visibility:auto}.text-shadow{text-shadow:0 2px 4px rgba(0,0,0,0.1)}.bg-gradient-cf{background:linear-gradient(135deg,#16181C 0%,#2A2E35 100%)}}</style></head><body class="bg-cloudflare-light font-sans text-cloudflare-dark antialiased"><header class="sticky top-0 z-50 bg-white/90 backdrop-blur-md shadow-sm"><div class="container mx-auto px-4 py-4 flex justify-between items-center"><div class="flex items-center space-x-2"><i class="fa-solid fa-shield-halved text-2xl text-cloudflare-blue"></i><span class="text-xl font-bold">Cloudflare Power</span></div><nav class="hidden md:flex space-x-8"><a href="#features" class="font-medium hover:text-cloudflare-blue transition-colors">核心特性</a><a href="#performance" class="font-medium hover:text-cloudflare-blue transition-colors">性能数据</a><a href="#protection" class="font-medium hover:text-cloudflare-blue transition-colors">安全防护</a><a href="#global" class="font-medium hover:text-cloudflare-blue transition-colors">全球网络</a></nav><button class="bg-cloudflare-blue text-white px-6 py-2 rounded-lg font-medium hover:bg-opacity-90 transition-all shadow-md hover:shadow-lg">立即使用</button></div></header><section class="bg-gradient-cf text-white py-20 md:py-32"><div class="container mx-auto px-4"><div class="max-w-3xl mx-auto text-center"><h1 class="text-[clamp(2.5rem,5vw,4rem)] font-bold leading-tight text-shadow mb-6">由 Cloudflare 强力驱动</h1><p class="text-xl text-gray-200 mb-10">全球 300+ 城市节点，99.99% 可用性，为你的网站提供极致性能与顶级安全防护</p><div class="flex flex-col sm:flex-row justify-center gap-4"><button class="bg-cloudflare-blue text-white px-8 py-3 rounded-lg text-lg font-medium hover:bg-opacity-90 transition-all shadow-lg hover:shadow-xl">查看性能报告</button><button class="bg-white/10 text-white border border-white/30 px-8 py-3 rounded-lg text-lg font-medium hover:bg-white/20 transition-all backdrop-blur-sm">了解更多</button></div><div class="mt-16 flex flex-wrap justify-center gap-4"><div class="bg-white/10 px-4 py-2 rounded-full backdrop-blur-sm flex items-center gap-2"><i class="fa-solid fa-bolt-lightning text-cloudflare-blue"></i><span>全球CDN加速</span></div><div class="bg-white/10 px-4 py-2 rounded-full backdrop-blur-sm flex items-center gap-2"><i class="fa-solid fa-shield-virus text-cloudflare-blue"></i><span>DDoS防护</span></div><div class="bg-white/10 px-4 py-2 rounded-full backdrop-blur-sm flex items-center gap-2"><i class="fa-solid fa-lock text-cloudflare-blue"></i><span>SSL/TLS加密</span></div><div class="bg-white/10 px-4 py-2 rounded-full backdrop-blur-sm flex items-center gap-2"><i class="fa-solid fa-globe text-cloudflare-blue"></i><span>300+ 数据中心</span></div><div class="bg-white/10 px-4 py-2 rounded-full backdrop-blur-sm flex items-center gap-2"><i class="fa-solid fa-code text-cloudflare-blue"></i><span>边缘计算</span></div></div></div></div></section><section id="features" class="py-20"><div class="container mx-auto px-4"><div class="text-center mb-16"><h2 class="text-3xl md:text-4xl font-bold mb-4">Cloudflare 核心优势</h2><p class="text-cloudflare-gray text-lg max-w-2xl mx-auto">一站式解决网站性能、安全、可靠性问题，无需复杂配置</p></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"><div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow p-6 border border-gray-100"><div class="w-14 h-14 bg-orange-50 rounded-lg flex items-center justify-center mb-6"><i class="fa-solid fa-rocket text-2xl text-cloudflare-blue"></i></div><h3 class="text-xl font-bold mb-3">极速CDN</h3><p class="text-cloudflare-gray">智能缓存策略，全球节点就近分发，页面加载速度提升90%以上</p></div><div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow p-6 border border-gray-100"><div class="w-14 h-14 bg-orange-50 rounded-lg flex items-center justify-center mb-6"><i class="fa-solid fa-shield-halved text-2xl text-cloudflare-blue"></i></div><h3 class="text-xl font-bold mb-3">全面安全防护</h3><p class="text-cloudflare-gray">内置DDoS防护、WAF、Bot管理，全方位抵御各类网络攻击</p></div><div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow p-6 border border-gray-100"><div class="w-14 h-14 bg-orange-50 rounded-lg flex items-center justify-center mb-6"><i class="fa-solid fa-infinity text-2xl text-cloudflare-blue"></i></div><h3 class="text-xl font-bold mb-3">99.99% 可用性</h3><p class="text-cloudflare-gray">全球分布式网络架构，单点故障不影响整体服务，保障业务持续在线</p></div><div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow p-6 border border-gray-100"><div class="w-14 h-14 bg-orange-50 rounded-lg flex items-center justify-center mb-6"><i class="fa-solid fa-lock text-2xl text-cloudflare-blue"></i></div><h3 class="text-xl font-bold mb-3">免费SSL证书</h3><p class="text-cloudflare-gray">一键启用HTTPS，自动续期，支持TLS 1.3，保障数据传输安全</p></div><div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow p-6 border border-gray-100"><div class="w-14 h-14 bg-orange-50 rounded-lg flex items-center justify-center mb-6"><i class="fa-solid fa-gears text-2xl text-cloudflare-blue"></i></div><h3 class="text-xl font-bold mb-3">边缘计算</h3><p class="text-cloudflare-gray">Workers 运行时环境，在全球边缘节点执行代码，降低延迟</p></div><div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow p-6 border border-gray-100"><div class="w-14 h-14 bg-orange-50 rounded-lg flex items-center justify-center mb-6"><i class="fa-solid fa-chart-line text-2xl text-cloudflare-blue"></i></div><h3 class="text-xl font-bold mb-3">实时分析</h3><p class="text-cloudflare-gray">详细的流量、性能、安全数据统计，帮助优化网站体验</p></div></div></div></section><section id="performance" class="py-20 bg-gray-50"><div class="container mx-auto px-4"><div class="text-center mb-16"><h2 class="text-3xl md:text-4xl font-bold mb-4">性能数据可视化</h2><p class="text-cloudflare-gray text-lg max-w-2xl mx-auto">使用 Cloudflare 前后的性能对比，数据一目了然</p></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="bg-white rounded-xl shadow-lg p-6"><h3 class="text-xl font-bold mb-4">页面加载速度对比 (ms)</h3><div class="h-80"><canvas id="speedChart"></canvas></div></div><div class="bg-white rounded-xl shadow-lg p-6"><h3 class="text-xl font-bold mb-4">全球各地区响应时间 (ms)</h3><div class="h-80"><canvas id="regionChart"></canvas></div></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-8 mt-12"><div class="bg-white rounded-xl shadow-lg p-6 text-center"><div class="text-4xl font-bold text-cloudflare-blue mb-2">99.99%</div><p class="text-cloudflare-gray">网络可用性</p></div><div class="bg-white rounded-xl shadow-lg p-6 text-center"><div class="text-4xl font-bold text-cloudflare-blue mb-2">85%</div><p class="text-cloudflare-gray">带宽节省率</p></div><div class="bg-white rounded-xl shadow-lg p-6 text-center"><div class="text-4xl font-bold text-cloudflare-blue mb-2">300+</div><p class="text-cloudflare-gray">全球数据中心</p></div></div></div></section><section id="protection" class="py-20"><div class="container mx-auto px-4"><div class="max-w-5xl mx-auto"><div class="text-center mb-16"><h2 class="text-3xl md:text-4xl font-bold mb-4">企业级安全防护</h2><p class="text-cloudflare-gray text-lg max-w-2xl mx-auto">从基础的DDoS防护到高级的Bot管理，全方位保障网站安全</p></div><div class="relative"><div class="bg-cloudflare-dark rounded-2xl p-8 text-white mb-12"><div class="flex flex-col md:flex-row items-center gap-8"><div class="md:w-1/2"><h3 class="text-2xl font-bold mb-4">智能威胁识别与拦截</h3><ul class="space-y-4"><li class="flex items-start gap-3"><i class="fa-solid fa-check-circle text-cloudflare-blue mt-1"></i><span>Layer 3/4/7 DDoS 防护，自动缓解各类攻击</span></li><li class="flex items-start gap-3"><i class="fa-solid fa-check-circle text-cloudflare-blue mt-1"></i><span>Web应用防火墙(WAF)，防护SQL注入、XSS等攻击</span></li><li class="flex items-start gap-3"><i class="fa-solid fa-check-circle text-cloudflare-blue mt-1"></i><span>Bot管理，识别并拦截恶意爬虫和自动化攻击</span></li><li class="flex items-start gap-3"><i class="fa-solid fa-check-circle text-cloudflare-blue mt-1"></i><span>Rate Limiting，防止暴力破解和API滥用</span></li></ul></div><div class="md:w-1/2"><img src="https://picsum.photos/seed/cloudflare-sec/600/400" alt="Cloudflare 安全防护" class="rounded-lg shadow-xl w-full"></div></div></div><div class="bg-white rounded-xl shadow-lg p-6 -mt-20 mx-4 relative z-10"><div class="grid grid-cols-1 md:grid-cols-4 gap-6 text-center"><div><div class="text-3xl font-bold text-cloudflare-blue mb-2">100Tbps+</div><p class="text-cloudflare-gray">DDoS防护容量</p></div><div><div class="text-3xl font-bold text-cloudflare-blue mb-2">76B+</div><p class="text-cloudflare-gray">每月拦截威胁</p></div><div><div class="text-3xl font-bold text-cloudflare-blue mb-2">99.9%</div><p class="text-cloudflare-gray">Bot识别准确率</p></div><div><div class="text-3xl font-bold text-cloudflare-blue mb-2">0秒</div><p class="text-cloudflare-gray">攻击缓解延迟</p></div></div></div></div></div></div></section><section id="global" class="py-20 bg-gray-50"><div class="container mx-auto px-4"><div class="text-center mb-16"><h2 class="text-3xl md:text-4xl font-bold mb-4">全球分布式网络</h2><p class="text-cloudflare-gray text-lg max-w-2xl mx-auto">遍布全球300+城市的边缘节点，让你的内容离用户更近</p></div><div class="bg-white rounded-xl shadow-lg p-6"><div class="aspect-w-16 aspect-h-9 mb-8"><img src="https://picsum.photos/seed/cloudflare-map/1200/675" alt="Cloudflare 全球网络地图" class="rounded-lg w-full h-auto"></div><div class="grid grid-cols-1 md:grid-cols-3 gap-8"><div class="text-center"><i class="fa-solid fa-globe-americas text-4xl text-cloudflare-blue mb-4"></i><h3 class="text-xl font-bold mb-2">覆盖范围</h3><p class="text-cloudflare-gray">遍布全球200+国家和地区，300+城市节点，覆盖所有主要互联网市场</p></div><div class="text-center"><i class="fa-solid fa-network-wired text-4xl text-cloudflare-blue mb-4"></i><h3 class="text-xl font-bold mb-2">网络质量</h3><p class="text-cloudflare-gray">直连全球顶级运营商，低延迟、高带宽，保障最佳用户体验</p></div><div class="text-center"><i class="fa-solid fa-server text-4xl text-cloudflare-blue mb-4"></i><h3 class="text-xl font-bold mb-2">弹性扩展</h3><p class="text-cloudflare-gray">自动扩缩容，无需人工干预，轻松应对流量峰值和突发访问</p></div></div></div></div></section><footer class="bg-cloudflare-dark text-white py-12"><div class="container mx-auto px-4"><div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8"><div><div class="flex items-center space-x-2 mb-4"><i class="fa-solid fa-shield-halved text-2xl text-cloudflare-blue"></i><span class="text-xl font-bold">Cloudflare Power</span></div><p class="text-gray-400 mb-4">让互联网更快速、更安全、更可靠</p><div class="flex space-x-4"><a href="#" class="text-gray-400 hover:text-cloudflare-blue transition-colors"><i class="fa-brands fa-twitter"></i></a><a href="#" class="text-gray-400 hover:text-cloudflare-blue transition-colors"><i class="fa-brands fa-github"></i></a><a href="#" class="text-gray-400 hover:text-cloudflare-blue transition-colors"><i class="fa-brands fa-linkedin"></i></a></div></div><div><h4 class="text-lg font-bold mb-4">产品</h4><ul class="space-y-2"><li><a href="#" class="text-gray-400 hover:text-white transition-colors">CDN</a></li><li><a href="#" class="text-gray-400 hover:text-white transition-colors">DDoS防护</a></li><li><a href="#" class="text-gray-400 hover:text-white transition-colors">WAF</a></li><li><a href="#" class="text-gray-400 hover:text-white transition-colors">Workers</a></li><li><a href="#" class="text-gray-400 hover:text-white transition-colors">R2存储</a></li></ul></div><div><h4 class="text-lg font-bold mb-4">资源</h4><ul class="space-y-2"><li><a href="#" class="text-gray-400 hover:text-white transition-colors">文档</a></li><li><a href="#" class="text-gray-400 hover:text-white transition-colors">开发者平台</a></li><li><a href="#" class="text-gray-400 hover:text-white transition-colors">状态页面</a></li><li><a href="#" class="text-gray-400 hover:text-white transition-colors">博客</a></li><li><a href="#" class="text-gray-400 hover:text-white transition-colors">社区</a></li></ul></div><div><h4 class="text-lg font-bold mb-4">公司</h4><ul class="space-y-2"><li><a href="#" class="text-gray-400 hover:text-white transition-colors">关于我们</a></li><li><a href="#" class="text-gray-400 hover:text-white transition-colors">客户案例</a></li><li><a href="#" class="text-gray-400 hover:text-white transition-colors">合作伙伴</a></li><li><a href="#" class="text-gray-400 hover:text-white transition-colors">招贤纳士</a></li><li><a href="#" class="text-gray-400 hover:text-white transition-colors">联系我们</a></li></ul></div></div><div class="border-t border-gray-800 pt-8 flex flex-col md:flex-row justify-between items-center"><p class="text-gray-500 mb-4 md:mb-0">© 2025 Cloudflare Power. All rights reserved.</p><div class="flex space-x-6"><a href="#" class="text-gray-500 hover:text-white transition-colors">隐私政策</a><a href="#" class="text-gray-500 hover:text-white transition-colors">服务条款</a><a href="#" class="text-gray-500 hover:text-white transition-colors">Cookie 设置</a></div></div></div></footer><script>document.addEventListener('DOMContentLoaded',function(){const e=document.getElementById('speedChart').getContext('2d');new Chart(e,{type:'bar',data:{labels:['亚太地区','欧洲','北美','南美','非洲','中东'],datasets:[{label:'使用Cloudflare前 (ms)',data:[850,620,450,780,950,720],backgroundColor:'#e5e7eb',borderColor:'#d1d5db',borderWidth:1},{label:'使用Cloudflare后 (ms)',data:[120,80,50,150,280,180],backgroundColor:'#F38020',borderColor:'#ea580c',borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'},tooltip:{mode:'index',intersect:false}},scales:{y:{beginAtZero:true,title:{display:true,text:'加载时间 (毫秒)'}}}}});const t=document.getElementById('regionChart').getContext('2d');new Chart(t,{type:'line',data:{labels:['东京','新加坡','伦敦','纽约','洛杉矶','悉尼','圣保罗'],datasets:[{label:'平均响应时间 (ms)',data:[45,52,38,25,30,65,85],fill:false,backgroundColor:'#F38020',borderColor:'#F38020',tension:0.3,pointRadius:5,pointBackgroundColor:'#F38020'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:true,title:{display:true,text:'响应时间 (毫秒)'}}}}});document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener('click',function(t){t.preventDefault();document.querySelector(this.getAttribute('href')).scrollIntoView({behavior:'smooth'})})});window.addEventListener('scroll',function(){const e=document.querySelector('header');window.scrollY>50?(e.classList.add('py-2'),e.classList.remove('py-4'),e.classList.add('shadow-md')):(e.classList.add('py-4'),e.classList.remove('py-2'),e.classList.remove('shadow-md'))})});</script></body></html>`",
            { headers: { "content-type": "text/html; charset=utf-8" } }
          );
        }

        if (url.pathname === `/${UUID}`) {
          return handleSubscriptionRequest(request);
        }
      }

      return new Response("Not Found", { status: 404 });
    } catch (e) {
      return new Response(String(e?.message || e), { status: 500 });
    }
  },
};

async function handleSubscriptionRequest(request) {
  const url = new URL(request.url);
  const host = url.hostname;

  const ech = ENABLE_ECH ? await fetchECH() : null;

  const nodes = await fetchCsvNodes(CSV_URL);
  const links = nodes.length
    ? nodes.map((n) => buildVlessLink(UUID, n.ip, n.port, n.name, host, ech))
    : [
        `vless://00000000-0000-0000-0000-000000000000@127.0.0.1:80?encryption=none&security=none&type=ws&host=error.com&path=%2F#${encodeURIComponent(
          "NO-NODES"
        )}`,
      ];

  return new Response(btoa(links.join("\n")), {
    headers: {
      "content-type": "text/plain; charset=utf-8",
      "cache-control": "no-store",
    },
  });
}

function buildVlessLink(uuid, ip, port, name, workerHost, ech) {
  const safeIP = ip.includes(":") ? `[${ip}]` : ip;
  const label = encodeURIComponent(name || `${ip}:${port}`);

  const p = new URLSearchParams({
    encryption: "none",
    security: "tls",
    sni: workerHost,
    fp: ech ? "chrome" : "randomized",
    type: "ws",
    host: workerHost,
    path: WS_PATH,
  });

  if (ech) {
    p.set("alpn", "h3,h2,http/1.1");
    p.set("ech", ech);
  }

  return `vless://${uuid}@${safeIP}:${port}?${p.toString()}#${label}`;
}

async function fetchCsvNodes(csvUrl) {
  try {
    const r = await fetch(csvUrl, { signal: AbortSignal.timeout(8000) });
    if (!r.ok) return [];
    const text = (await r.text()).trim().replace(/\r/g, "");
    if (!text) return [];

    // 格式: ip:port#name
    const out = [];
    for (const line of text.split("\n")) {
      const s = line.trim();
      if (!s) continue;
      const m = s.match(/^([^:]+):(\d+)\s*#\s*(.*)$/);
      if (!m) continue;
      out.push({ ip: m[1], port: Number(m[2]), name: (m[3] || m[1]).trim() });
    }
    return out;
  } catch {
    return [];
  }
}

/** 尽量短：只查 cloudflare-ech.com 的 65 记录，提取 ech=... */
async function fetchECH() {
  const tries = [
    ["https://cloudflare-dns.com/dns-query?name=cloudflare-ech.com&type=65", "application/dns-json"],
    ["https://dns.google/resolve?name=cloudflare-ech.com&type=65", "application/json"],
  ];

  for (const [u, accept] of tries) {
    try {
      const r = await fetch(u, {
        headers: { Accept: accept },
        signal: AbortSignal.timeout(5000),
      });
      if (!r.ok) continue;
      const j = await r.json();
      const ans = j?.Answer || [];
      for (const a of ans) {
        const d = String(a?.data || "");
        const m = d.match(/ech=([^\s"']+)/);
        if (m?.[1]) return m[1];
        // 有些实现会把 data 做 base64，这里兼容一下
        try {
          const decoded = atob(d);
          const m2 = decoded.match(/ech=([^\s"']+)/);
          if (m2?.[1]) return m2[1];
        } catch {}
      }
    } catch {}
  }
  return null;
}

async function handleWsRequest(request) {
  const pair = new WebSocketPair();
  const [client, server] = Object.values(pair);
  server.accept();

  let remote = null;
  let isDns = false;

  const early = request.headers.get("sec-websocket-protocol") || "";
  const readable = makeReadableStream(server, early);

  readable
    .pipeTo(
      new WritableStream({
        async write(chunk) {
          if (isDns) return forwardDns(chunk, server, null);

          if (remote) {
            const w = remote.writable.getWriter();
            await w.write(chunk);
            w.releaseLock();
            return;
          }

          const h = parseHeader(chunk, UUID);
          if (h.err) throw new Error(h.err);

          if (h.isUDP) {
            if (h.port !== 53) throw new Error("UDP only for DNS(53)");
            isDns = true;
            return forwardDns(chunk.slice(h.dataIndex), server, new Uint8Array([h.ver, 0]));
          }

          const respHeader = new Uint8Array([h.ver, 0]);
          const raw = chunk.slice(h.dataIndex);

          await forwardTcp(h.host, h.port, raw, server, respHeader, (sock) => (remote = sock));
        },
      })
    )
    .catch(() => closeQuiet(server));

  return new Response(null, { status: 101, webSocket: client });
}

async function forwardTcp(host, port, firstData, ws, respHeader, setRemote) {
  const connectOnce = async (h, p) => {
    const s = connect({ hostname: h, port: p });
    const w = s.writable.getWriter();
    await w.write(firstData);
    w.releaseLock();
    return s;
  };

  const connectWithFallback = async () => {
    const s = await connectOnce(FALLBACK_HOST || host, FALLBACK_PORT || port);
    setRemote(s);
    s.closed.catch(() => {}).finally(() => closeQuiet(ws));
    pipeRemoteToWs(s, ws, respHeader);
  };

  try {
    const s = await connectOnce(host, port);
    setRemote(s);
    pipeRemoteToWs(s, ws, respHeader, connectWithFallback);
  } catch {
    await connectWithFallback();
  }
}

function pipeRemoteToWs(remote, ws, header, retry) {
  let hasData = false;
  remote.readable
    .pipeTo(
      new WritableStream({
        async write(chunk, controller) {
          hasData = true;
          if (ws.readyState !== 1) return controller.error("ws not open");

          if (header) {
            ws.send(concatU8(header, chunk));
            header = null;
          } else {
            ws.send(chunk);
          }
        },
      })
    )
    .catch(() => closeQuiet(ws))
    .finally(() => {
      if (!hasData && retry) retry();
    });
}

async function forwardDns(udpData, ws, header) {
  try {
    const s = connect({ hostname: "8.8.4.4", port: 53 });
    let h = header;

    const w = s.writable.getWriter();
    await w.write(udpData);
    w.releaseLock();

    await s.readable.pipeTo(
      new WritableStream({
        async write(chunk) {
          if (ws.readyState !== 1) return;
          if (h) {
            ws.send(concatU8(h, chunk));
            h = null;
          } else {
            ws.send(chunk);
          }
        },
      })
    );
  } catch {}
}

function parseHeader(buf, uuid) {
  if (buf.byteLength < 24) return { err: "invalid data" };

  const u8 = new Uint8Array(buf);
  const ver = u8[0];

  // UUID: bytes[1..16]
  if (bytesToUuid(u8, 1) !== uuid) return { err: "invalid user" };

  const optLen = u8[17];
  const cmd = u8[18 + optLen];
  const isUDP = cmd === 2;
  if (cmd !== 1 && cmd !== 2) return { err: "unsupported cmd" };

  const portIndex = 19 + optLen;
  const port = (u8[portIndex] << 8) | u8[portIndex + 1];

  let idx = portIndex + 2;
  const at = u8[idx++];

  let host = "";
  if (at === AT_IPV4) {
    host = `${u8[idx++]}.${u8[idx++]}.${u8[idx++]}.${u8[idx++]}`;
  } else if (at === AT_DOMAIN) {
    const len = u8[idx++];
    host = td.decode(buf.slice(idx, idx + len));
    idx += len;
  } else if (at === AT_IPV6) {
    const dv = new DataView(buf, idx, 16);
    const parts = [];
    for (let i = 0; i < 8; i++) parts.push(dv.getUint16(i * 2).toString(16));
    host = parts.join(":");
    idx += 16;
  } else {
    return { err: "bad addr type" };
  }

  if (!host) return { err: "empty host" };
  return { ver, isUDP, port, host, dataIndex: idx };
}

function makeReadableStream(ws, earlyDataHeader) {
  let cancelled = false;

  return new ReadableStream({
    start(controller) {
      ws.addEventListener("message", (e) => !cancelled && controller.enqueue(e.data));
      ws.addEventListener("close", () => {
        if (cancelled) return;
        closeQuiet(ws);
        controller.close();
      });
      ws.addEventListener("error", (e) => controller.error(e));

      const early = base64ToArrayBuffer(earlyDataHeader);
      if (early) controller.enqueue(early);
    },
    cancel() {
      cancelled = true;
      closeQuiet(ws);
    },
  });
}

function base64ToArrayBuffer(s) {
  if (!s) return null;
  try {
    s = s.replace(/-/g, "+").replace(/_/g, "/");
    const bin = atob(s);
    const u8 = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) u8[i] = bin.charCodeAt(i);
    return u8.buffer;
  } catch {
    return null;
  }
}

function concatU8(headerU8, chunk) {
  const b = chunk instanceof ArrayBuffer ? new Uint8Array(chunk) : new Uint8Array(chunk);
  const out = new Uint8Array(headerU8.length + b.length);
  out.set(headerU8, 0);
  out.set(b, headerU8.length);
  return out.buffer;
}

function closeQuiet(ws) {
  try {
    if (ws.readyState === 1 || ws.readyState === 2) ws.close();
  } catch {}
}

const HEX = Array.from({ length: 256 }, (_, i) => (i + 256).toString(16).slice(1));
function bytesToUuid(arr, o) {
  return (
    HEX[arr[o]] +
    HEX[arr[o + 1]] +
    HEX[arr[o + 2]] +
    HEX[arr[o + 3]] +
    "-" +
    HEX[arr[o + 4]] +
    HEX[arr[o + 5]] +
    "-" +
    HEX[arr[o + 6]] +
    HEX[arr[o + 7]] +
    "-" +
    HEX[arr[o + 8]] +
    HEX[arr[o + 9]] +
    "-" +
    HEX[arr[o + 10]] +
    HEX[arr[o + 11]] +
    HEX[arr[o + 12]] +
    HEX[arr[o + 13]] +
    HEX[arr[o + 14]] +
    HEX[arr[o + 15]]
  );
}
